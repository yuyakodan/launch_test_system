name: Meta API Version Check

on:
  schedule:
    - cron: '0 9 * * 1'  # æ¯é€±æœˆæ›œ9æ™‚
  workflow_dispatch:

jobs:
  check-version:
    name: Check Meta Marketing API Version
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check API Version Expiry
        run: |
          echo "Meta Marketing API ãƒãƒ¼ã‚¸ãƒ§ãƒ³æœŸé™ãƒã‚§ãƒƒã‚¯"
          echo "ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v22.0"
          echo "æœŸé™: 2026-01-13"

          EXPIRY_DATE="2026-01-13"
          TODAY=$(date +%Y-%m-%d)
          DAYS_LEFT=$(( ($(date -d "$EXPIRY_DATE" +%s) - $(date -d "$TODAY" +%s)) / 86400 ))

          if [ $DAYS_LEFT -le 7 ]; then
            echo "::error::Meta API v22.0 ã®æœŸé™ãŒ7æ—¥ä»¥å†…ã§ã™ï¼å³æ™‚å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"
            exit 1
          elif [ $DAYS_LEFT -le 30 ]; then
            echo "::warning::Meta API v22.0 ã®æœŸé™ãŒ30æ—¥ä»¥å†…ã§ã™ã€‚ç§»è¡Œè¨ˆç”»ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
          elif [ $DAYS_LEFT -le 60 ]; then
            echo "::notice::Meta API v22.0 ã®æœŸé™ãŒ60æ—¥ä»¥å†…ã§ã™ã€‚"
          else
            echo "Meta API v22.0 ã®æ®‹ã‚Šæ—¥æ•°: $DAYS_LEFT æ—¥"
          fi
      - name: Create Issue if Urgent
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Meta API ãƒãƒ¼ã‚¸ãƒ§ãƒ³æœŸé™åˆ‡ã‚Œè­¦å‘Š',
              body: 'Meta Marketing API v22.0 ã®æœŸé™ãŒè¿«ã£ã¦ã„ã¾ã™ã€‚æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¸ã®ç§»è¡ŒãŒå¿…è¦ã§ã™ã€‚',
              labels: ['priority:P0-Critical', 'domain:meta-api', 'type:chore']
            })
