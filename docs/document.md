システム要件定義書（フル実装）

1. 目的・成功条件

1.1 目的
• 広告配信を“実験”として標準化し、短期間で**勝ち筋（訴求 ×LP× クリエイティブ × 配信条件）**を確定する
• 制作/配信/計測/改善の分断をなくし、再現性と監査性を担保する

1.2 成功条件（システムが満たすべき状態）
• Run 単位で「設計 → 生成 → 承認 → 公開 → 配信 → 自動停止 → 判定 → 学習 → 次 Run 生成」が完結
• 誤配信・予算超過・計測欠落・権限事故が仕組みで起きにくい
• 多顧客（多テナント）で安全に運用できる（権限・分離・監査ログ）

⸻

2. スコープ

2.1 In scope（必須）
• 多テナント管理（顧客/プロジェクト/ユーザー/権限）
• ヒアリング入力（テンプレ＋対話）→ 検証設計（KPI/停止条件/最低サンプル/探索軸）
• LP 生成（複数バリアント）、編集、版管理、承認フロー
• クリエイティブ生成（複数サイズ/複数案）、編集/差し替え、承認フロー
• Cloudflare 公開（Run/Variant URL 発行）、ロールバック、公開停止
• Meta 広告作成（Campaign/Adset/Ad）、配信開始/停止/更新、Insights 取得
• 計測（UTM 統一、イベント定義、集計）
• 自動停止（上限/CPA/CV ゼロ/エラー連続）
• 勝ち判定、学習レポート、次ラウンド生成
• 監査ログ、通知、運用保守（API 期限/失敗リトライ/ジョブ監視）

2.2 Out of scope（明確に除外）
• 売上/審査通過の保証（システム要件外）
• 法務審査の代行（最終判断は利用者側）
• 撮影/動画制作

⸻

3. ユーザー/権限（RBAC）

3.1 ロール
• Tenant Owner：請求/支払い、テナント設定、最終承認、監査閲覧
• Operator：Run 作成、生成、デプロイ、広告配信/停止、レポート
• Reviewer：配信前承認（LP/画像/設定）
• Viewer：閲覧のみ

3.2 強制ルール
• Approved になっていない Run は配信開始不可
• 予算上限未設定の Adset 作成/配信開始は不可
• 全操作は監査ログ必須（誰が/いつ/何を/前後差分）

⸻

4. ドメイン要件（Cloudflare 前提の設計）

4.1 基本方針
• 「頻繁にビルドしない」：Pages のビルド回数/時間制約（Free 月 500 ビルド、20 分タイムアウト）を踏まえ、Run 量産でも耐える構成にする ￼
• **公開は“1 回のデプロイ＋データ差し替え”**が基本（LP 本文や構成は JSON/DB から注入）

4.2 推奨構成（実装要件）
• Pages：管理画面（SPA）と共通公開テンプレ（LP ランタイム）
• Workers：API（RBAC、生成ジョブ、Meta 連携、集計、停止判定）
• D1：メタデータ（Run/Variant/設定/ログ/集計）
• R2：画像アセット、生成物、エクスポート、ログ添付
• KV：キャッシュ（LP レンダリング用、設定のホットキャッシュ）
• Queues：生成・デプロイ・同期・集計の非同期ジョブ
• Durable Objects：Run 単位の状態管理（停止判定/排他/レート制御）
• Cron Triggers：Insights 同期、停止判定、期限監視、日次レポート生成

⸻

5. 機能要件（フル）

5.1 テナント/プロジェクト管理
• テナント作成、支払いプラン設定、ユーザー招待、RBAC
• プロジェクト（商材単位）作成：CV 定義、注意文テンプレ、禁則、ブランド設定
• 監査：テナント横断の操作履歴検索（期間/ユーザー/対象で絞り込み）

5.2 ヒアリング & 検証設計

入力（必須）
• 商材/価格/提供範囲（できる・できない）
• 実績/根拠（数値/事例/レビュー）
• FAQ（5〜10+）
• NG 表現/禁則/注意文
• CV 定義（イベント名、完了条件）
• 予算枠（総額/日額）
• ターゲット仮説、オファー

出力（必須）
• 訴求軸案（最低 3 本）
• 実験計画：探索軸、最低サンプル、勝ち判定ルール
• 停止条件テンプレ（推奨値＋編集）

5.3 LP バリアント管理（生成/編集/版管理）
• Variant 作成（訴求/構成タイプ/オファー差分）
• 生成後に編集可能（ブロック/セクション単位、コンポーネント化）
• 版管理（下書き/提出/承認/公開済み、差分、ロールバック）
• エクスポート（HTML/JSON/PDF）＋監査用スナップショット保存

5.4 クリエイティブ管理（生成/差し替え/サイズ）
• サイズ：1:1 / 4:5 / 9:16（必須）＋追加サイズ
• 文字要素はテンプレレイヤー化（後から文言差し替え可能）
• 画像差し替え（アップロード、トリミング、セーフエリア）
• 禁則チェック（NG ワード/断定表現/過剰煽りなどのルールベース警告）

5.5 承認フロー（最重要）
• 承認対象：LP/画像/計測/停止条件/予算上限/配信先 URL
• 承認方法：チェックリスト＋コメント＋承認記録（誰がいつ）
• 承認ゲート：Approved 以外は「配信開始」ボタン無効

5.6 公開（Run/Variant URL 発行）
• Run 単位の公開 URL、Variant 単位の URL/パラメータ
• 公開停止、ロールバック、アーカイブ
• ランタイムレンダリング（DB/KV から構成 JSON を取得し描画）
• 「公開物の証跡」：公開時点のスナップショットを R2 に保存

5.7 Meta 広告連携（Marketing API）
• 接続：OAuth（テナントごとに認可）、トークン保管、更新
• 作成：Campaign/Adset/Ad（テンプレ＋パラメータ）
• 予算上限：日額/総額（可能な範囲でシステム側制約）
• 配信操作：開始/停止/更新、審査ステータス取得
• Insights 同期：日次/時間単位で取得し、Variant に紐付け

API 保守（必須）
• Marketing API のバージョン固定・期限監視・移行手順（v22.0 が 2026-01-13 まで等の期限を検知） ￼
• 期限 60/30/7 日前に通知、期限切れ前に段階的に新バージョンへ切替

5.8 計測（UTM/イベント/集計）
• UTM 規約を強制：run_id lp_variant_id creative_variant_id ad_id adset_id
• イベント：PageView / CTA クリック / FormStart / FormSubmit（CV）
• 集計：日次・期間・Variant 別、Ad/Adset 別
• データ完全性チェック：
• UTM 欠落
• イベント発火なし
• URL 不整合（広告 URL と公開 URL のズレ）

5.9 自動停止（Guardrails）
• 停止条件（必須）
• 総額上限、日額上限
• CPA 上限（一定サンプル後）
• CV ゼロ継続（時間）
• エラー連続（LP 取得失敗/イベント欠落/Insights 取得失敗）
• 停止実行：API で停止（不可なら通知＋手動停止フロー）
• 停止理由と時刻を監査ログ＋ Run ログに保存

5.10 勝ち判定・学習・次ラウンド生成
• 勝ち判定：事前定義ルールで自動確定（例：最低サンプル後に CPA 最小）
• 学習レポート生成（テンプレ）
• 勝った訴求/構成/CTA/画像要素
• 負けた要素の仮説
• 次 Run の「固定/探索」指示
• 次 Run 生成：勝ち要素を固定し、差分パラメータだけ変えて Variant 自動作成

5.11 通知・レポート配信
• 通知先：Slack / Email / Webhook
• 通知イベント：
• 承認依頼、承認完了
• 配信開始/停止
• 停止条件発火
• API 期限警告
• 日次サマリ、Run 完了

5.12 請求・プラン（システム機能として）
• テナントのプラン管理（Lite/Standard/Pro/Growth 等）
• 機能制限（Run 数、Variant 上限、同期頻度、ストレージ）
• 利用状況メーター（今月の Run/生成数/ストレージ）
• 請求履歴、領収書/請求書のダウンロード（連携先は後述）

⸻

6. 非機能要件

6.1 性能・スケーラビリティ
• 多テナント：1000 テナントを想定、テナント間の負荷隔離
• ジョブは Queues で平準化、Durable Objects で排他（Run 単位）
• D1 は 1DB 最大 10GB・増枠不可のため、テナント DB 分割 or 時系列アーカイブが必須 ￼

6.2 可用性・障害時設計
• 外部 API（Meta）失敗時：
• リトライ（指数バックオフ）
• フォールバック（通知 → 手動手順）
• “安全側”に倒す：停止判定が曖昧なら 一時停止＋通知

6.3 セキュリティ
• 認証：Magic link or OAuth + MFA（Owner/Operator）
• 秘密情報：トークン暗号化保管、ローテーション、アクセス最小化
• PII：フォームデータの保存は最小限（保存するなら暗号化＋保持期間）
• 監査ログ：改ざん耐性（追記型、R2 への定期スナップショット）

6.4 運用・監視
• 監視：ジョブ滞留、API エラー率、同期遅延、停止条件発火率
• API 期限監視：バージョンの Available until をベースにアラート ￼
• Pages ビルド回数の抑制（Free 月 500、20 分タイムアウト）を考慮し、LP はデータ駆動で更新 ￼

6.5 コンプライアンス
• 利用規約：売上/審査保証なし、責任分界、禁止用途
• データ保持：Run/ログ/PII の保持期間ポリシー（テナント設定可）

⸻

7. データ設計（論理モデル）

主要テーブル（例）
• tenants, users, roles, memberships
• projects（商材/オファー）
• runs（設計、状態、停止条件、予算上限）
• variants_lp（構成 JSON、版、承認、公開 URL）
• variants_creative（サイズ、アセット参照、承認）
• deployments（公開スナップショット、ロールバック）
• meta_connections（認可情報メタ、暗号化参照）
• meta_entities（campaign/adset/ad 外部 ID、状態）
• metrics_daily / metrics_hourly（集計）
• stop_events（停止理由、時刻、対象）
• audit_logs（操作履歴）
• notifications（送信記録）

⸻

8. 状態遷移（Run ステートマシン）
   • Draft
   • Designing
   • Generating
   • ReadyForReview
   • Approved（ゲート）
   • Publishing
   • Live（配信可能）
   • Running（配信中）
   • Paused
   • Completed
   • Archived

遷移制約
• ReadyForReview → Approved：Reviewer/Owner のみ
• Approved なしで Running へ遷移不可
• Paused/Completed は再開条件付き

⸻

9. 画面要件（管理 UI）

必須画面 1. ログイン/2FA 2. テナント設定（プラン/通知/ドメイン/権限） 3. プロジェクト一覧/詳細（商材情報、CV 定義、禁則） 4. Run 作成ウィザード（設計 → 探索軸 → 停止条件 → 確認） 5. Variant 管理（LP/画像、編集、版、差分、承認） 6. 公開管理（URL、スナップショット、ロールバック） 7. Meta 配信管理（構造、ステータス、停止） 8. 計測/レポート（Variant 別、勝ち判定、学習、次 Run 作成） 9. 監査ログ閲覧（フィルタ、エクスポート） 10. 通知履歴、インシデント履歴

⸻

10. API 要件（内部/外部）
    • REST or tRPC（どちらでも）＋ OpenAPI 出力
    • 主要 API（例）
    • POST /runs, POST /runs/:id/generate, POST /runs/:id/approve
    • POST /runs/:id/publish, POST /runs/:id/launch, POST /runs/:id/pause
    • GET /reports/:runId, GET /insights/:runId
    • POST /meta/connect, POST /meta/sync
    • POST /stop-rules/evaluate
    • Webhook 受信（Meta のイベントが必要なら）

⸻

11. 外部連携
    • Meta Marketing API（必須）＋期限管理 ￼
    • Slack/Email/Webhook（必須）
    • 請求：Stripe 等（推奨、要件として抽象化）

⸻

12. 制約と設計上の必須判断
    • Pages のビルド制約（Free 月 500/20 分）を踏まえ、LP を“ビルド生成物”として量産しない ￼
    • D1 10GB 制約を踏まえ、
    • テナント DB 分割
    • 集計のスリム化（raw を持ちすぎない）
    • Run のアーカイブ（R2 へ）
    を必須とする ￼
    • Workers の Paid 最低$5/月を、環境（prod/stg）ごとに見積もりに含める ￼
    • Meta API のバージョン期限はプロダクト保守の中核要件（アラート＋切替計画） ￼

⸻

13. 受け入れ基準（フル実装の完了条件）
    • 1 テナントが、管理画面から
    • Run 設計 →LP/画像生成 → 承認 → 公開 →Meta 配信 → 自動停止 → 勝ち判定 → 次 Run 生成
    を 手戻りなく完走できる
    • 承認なし配信・予算上限なし配信・UTM 欠落が UI/API 両方で防止される
    • 監査ログで「誰がいつ何を変えたか」が追える
    • Meta API 期限監視が動作し、期限警告が通知される ￼
